name: Deploy Backend to ECS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
  push:
    branches:
      - main
    paths:
      - 'journaly-backend/**'
      - '.github/workflows/deploy-backend.yml'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: journaly-${{ github.event.inputs.environment || 'dev' }}-backend

jobs:
  deploy:
    name: Deploy Backend
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Extract metadata for Docker
        id: meta
        run: |
          echo "image_tag=$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          echo "ecr_registry=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_OUTPUT

      - name: Build Docker image
        working-directory: journaly-backend
        run: |
          docker build -t ${{ steps.meta.outputs.ecr_registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.image_tag }} .
          docker tag ${{ steps.meta.outputs.ecr_registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.image_tag }} \
                     ${{ steps.meta.outputs.ecr_registry }}/${{ env.ECR_REPOSITORY }}:latest

      - name: Run security scan on Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.ecr_registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.image_tag }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Push Docker image to ECR
        run: |
          docker push ${{ steps.meta.outputs.ecr_registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.meta.outputs.image_tag }}
          docker push ${{ steps.meta.outputs.ecr_registry }}/${{ env.ECR_REPOSITORY }}:latest

      - name: Get ECS cluster and service names
        id: ecs-info
        run: |
          CLUSTER_NAME="journaly-${{ github.event.inputs.environment || 'dev' }}-cluster"
          SERVICE_NAME="journaly-${{ github.event.inputs.environment || 'dev' }}-backend-service"
          TASK_FAMILY="journaly-${{ github.event.inputs.environment || 'dev' }}-backend"
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "task_family=$TASK_FAMILY" >> $GITHUB_OUTPUT

      - name: Get VPC configuration for migration task
        id: vpc-config
        run: |
          # Get VPC and subnet info from the ECS service
          SERVICE_INFO=$(aws ecs describe-services \
            --cluster ${{ steps.ecs-info.outputs.cluster_name }} \
            --services ${{ steps.ecs-info.outputs.service_name }} \
            --region ${{ env.AWS_REGION }})
          
          SUBNETS=$(echo $SERVICE_INFO | jq -r '.services[0].networkConfiguration.awsvpcConfiguration.subnets | join(",")')
          SECURITY_GROUPS=$(echo $SERVICE_INFO | jq -r '.services[0].networkConfiguration.awsvpcConfiguration.securityGroups | join(",")')
          
          echo "subnets=$SUBNETS" >> $GITHUB_OUTPUT
          echo "security_groups=$SECURITY_GROUPS" >> $GITHUB_OUTPUT

      - name: Run database migrations
        run: |
          echo "Running database migrations..."
          
          # Get the latest task definition
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition ${{ steps.ecs-info.outputs.task_family }} \
            --region ${{ env.AWS_REGION }})
          
          # Update the task definition to override the command for migration
          TASK_DEF_ARN=$(echo $TASK_DEF | jq -r '.taskDefinition.taskDefinitionArn')
          
          # Run migration as a one-off task
          TASK_ARN=$(aws ecs run-task \
            --cluster ${{ steps.ecs-info.outputs.cluster_name }} \
            --task-definition ${{ steps.ecs-info.outputs.task_family }} \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ steps.vpc-config.outputs.subnets }}],securityGroups=[${{ steps.vpc-config.outputs.security_groups }}],assignPublicIp=DISABLED}" \
            --overrides '{
              "containerOverrides": [
                {
                  "name": "backend",
                  "command": ["sh", "-c", "npx prisma migrate deploy && echo Migration completed"]
                }
              ]
            }' \
            --region ${{ env.AWS_REGION }} \
            | jq -r '.tasks[0].taskArn')
          
          echo "Migration task ARN: $TASK_ARN"
          
          # Wait for migration task to complete
          aws ecs wait tasks-stopped \
            --cluster ${{ steps.ecs-info.outputs.cluster_name }} \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }}
          
          # Check if migration succeeded
          TASK_EXIT_CODE=$(aws ecs describe-tasks \
            --cluster ${{ steps.ecs-info.outputs.cluster_name }} \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }} \
            | jq -r '.tasks[0].containers[] | select(.name=="backend") | .exitCode')
          
          if [ "$TASK_EXIT_CODE" != "0" ]; then
            echo "âŒ Migration failed with exit code: $TASK_EXIT_CODE"
            exit 1
          fi
          
          echo "âœ… Migration completed successfully"

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ steps.ecs-info.outputs.cluster_name }} \
            --service ${{ steps.ecs-info.outputs.service_name }} \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for ECS service to stabilize
        run: |
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ steps.ecs-info.outputs.cluster_name }} \
            --services ${{ steps.ecs-info.outputs.service_name }} \
            --region ${{ env.AWS_REGION }}

      - name: Get deployment info
        id: deployment-info
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --query "LoadBalancers[?contains(LoadBalancerName, 'journaly-${{ github.event.inputs.environment || 'dev' }}')].DNSName" \
            --output text \
            --region ${{ env.AWS_REGION }})
          echo "alb_dns=$ALB_DNS" >> $GITHUB_OUTPUT

      - name: Health check
        run: |
          echo "Testing health endpoint..."
          curl -f http://${{ steps.deployment-info.outputs.alb_dns }}/health || exit 1
          echo "âœ… Health check passed!"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Backend Deployment Successful

          **Environment:** \`${{ github.event.inputs.environment || 'dev' }}\`
          **Image Tag:** \`${{ steps.meta.outputs.image_tag }}\`
          **ECS Cluster:** \`${{ steps.ecs-info.outputs.cluster_name }}\`
          **ECS Service:** \`${{ steps.ecs-info.outputs.service_name }}\`

          ### ðŸ”— Endpoints

          - **API URL:** http://${{ steps.deployment-info.outputs.alb_dns }}
          - **Health Check:** http://${{ steps.deployment-info.outputs.alb_dns }}/health

          ### ðŸ“Š Logs

          View logs:
          \`\`\`bash
          aws logs tail /ecs/journaly-${{ github.event.inputs.environment || 'dev' }}/backend --follow
          \`\`\`

          **Deployed by:** @${{ github.actor }}
          **Commit:** ${{ github.sha }}
          EOF
